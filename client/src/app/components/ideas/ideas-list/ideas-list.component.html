<button mat-raised-button style="width:100%" color="primary" (click)="showCreateNewIdea()">Új ötlet kiírása</button>
<button mat-mini-fab (click)="refreshList()" style="margin-top:1em;">
  <mat-icon>refresh</mat-icon>
</button>

<mat-spinner style="margin-top:1em;" *ngIf="!(ideas$ | async)"></mat-spinner>
<ng-container *ngFor="let idea of (ideas$ | async)">
  <mat-card style="margin-top: .8em;">
    <mat-card-content>
      <div class="d-flex flex-row align-items-center" >
        <!-- Ez az ötlet nekik szól: -->
        <kariaji-user-avatar [size]="30" style="margin-left: 3px;" [userId]="id" *ngFor="let id of idea.targetUserIds"></kariaji-user-avatar>
        <span class="flex-grow-1">&nbsp;</span>
        <span class="badge badge-pill badge-secondary" style="font-size: normal">{{idea.creationTime}}</span>
        <button style="margin-left:1em;" color="accent" mat-mini-fab title="Részletek" (click)="showDetailsOfIdea(idea)">
          <mat-icon [matBadge]="idea.comments ? idea.comments.length : ''" [matBadgeHidden]="!idea.comments || !idea.comments.length" matBadgeColor="primary">info</mat-icon>
        </button>

      </div>
      <div style="margin-top:8px"></div>
      <mat-divider [inset]="true"></mat-divider>
      <div style="margin-top:8px"></div>
      <!-- <span style="font-size:smaller;border-bottom:1px solid lightgray">{{idea.creationTime}}</span> -->
      <div class="d-md-flex flex-row align-items-center">
        <!-- <div class="d-flex flex-column" style="padding-right: 1em; border-right: 1px solid lightgray; " title="Címzettek">
          <kariaji-user-avatar style="margin-top:4px;" [userId]="id" *ngFor="let id of idea.targetUserIds"></kariaji-user-avatar>
        </div> -->
        <!-- <mat-icon style="margin-top:4px;">drag_indicator</mat-icon> -->
        <div style="margin-left:1em;margin-top:4px;" class="align-self-center flex-grow-1 user-text" [innerHtml]="getText(idea.textDelta)"></div>
        <!-- <button style="margin-left:auto;" *ngIf="isReservationButtonVisible(idea)" [disabled]="isReservationButtonDisabled(idea)"  mat-raised-button>{{getReservationButtonText(idea)}}</button> -->

        <div class="d-flex flex-column align-items-end">
          <button *ngIf="canReserve(idea) && !idea.isReserved" mat-raised-button color="accent" (click)="reserve(idea)">Lefoglalom</button>
          <button mat-button color="warn" *ngIf="canReserve(idea) && idea.isReserved && !idea.reservation">Más már lefoglalta</button>
          <button *ngIf="canReserve(idea) && idea.reservation && idea.reservation && (idea.reservation.reserverUserId !== userId)" mat-button [matBadge]="idea.reservation.joinedUserIds ? idea.reservation.joinedUserIds.length : 0" [matBadgeHidden]="!idea.reservation.canJoin" (click)="idea.reservation.canJoin && showJoinedUsers(idea.reservation)">
            <div class="d-flex flex-row align-items-center">
              <kariaji-user-avatar size="30" [userId]="idea.reservation.reserverUserId"></kariaji-user-avatar>
              <span>&nbsp;már lefoglalta{{getTextIfCanJoinForOthersReservation(idea.reservation)}}</span>
            </div>
          </button>
          <button mat-raised-button style="margin-top:1em;" *ngIf=" idea.reservation && idea.reservation.canJoin && (idea.reservation.reserverUserId !== userId) && !isUserJoined(idea.reservation)" (click)="join(idea.reservation)">
            Csatlakozom
          </button>
          <button mat-raised-button *ngIf="idea.reservation && isUserJoined(idea.reservation)" (click)="removeJoin(idea.reservation, userId)">
            Csatlakoztam, de visszalépek
          </button>
          <div *ngIf="canReserve(idea) && idea.reservation && (idea.reservation.reserverUserId === userId)" class="d-flex flex-column">
            <button color="warn" mat-raised-button (click)="deleteReservation(idea)">
              <mat-icon>delete</mat-icon>
              Visszavonom a foglalást
            </button>
            <mat-slide-toggle style="margin-top:1em" color="primary" [checked]="idea.reservation.canJoin" (change)="updateCanJoin(idea.reservation)">
              Lehet csatlakozni?
            </mat-slide-toggle>
            <button style="margin-top:1em" mat-raised-button *ngIf="(idea.reservation.joinedUserIds && idea.reservation.joinedUserIds.length)" matBadge="{{idea.reservation.joinedUserIds ? idea.reservation.joinedUserIds.length : 0}}" (click)="showJoinedUsers(idea.reservation)">
              Csatlakozások
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</ng-container>



<ng-template #joinedUsersDialogTemplate>
  <h2 mat-dialog-title>
    {{(detailedReservation && detailedReservation.joinedUserIds && detailedReservation.joinedUserIds.length ) ? 'Eddig csatlakoztak' : 'Még nem csatlakozott senki'}}
  </h2>
  <mat-dialog-content *ngIf="detailedReservation">
    <div class="d-flex flex-column">
      <div *ngFor="let joinedUserId of detailedReservation.joinedUserIds" class="d-flex flex-row">
        <kariaji-user-avatar [userId]="joinedUserId"> </kariaji-user-avatar>
        <button mat-mini-fab style="margin-left:2em" color="warn" (click)="removeJoin(detailedReservation, joinedUserId)" *ngIf="(joinedUserId === userId) ||(userId === detailedReservation.reserverUserId)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
    <br />
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button mat-dialog-close>VISSZA</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #newIdeaDialogTemplate>
    <kariaji-new-idea (finished)="closeNewIdeaDialog()"></kariaji-new-idea>
</ng-template>
<ng-template #editIdeaDialogTemplate>
  <kariaji-edit-idea  [detailedIdea]="detailedIdea" (finished)="closeEditIdeaDialog()"></kariaji-edit-idea>
</ng-template>